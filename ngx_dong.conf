lua_shared_dict limit 10m;

server {
    listen 80;
    server_name dong.company.inc;
    location /demo {
        add_header Content-Type "text/html;charset=utf-8";
        content_by_lua '
            local limit = ngx.shared.limit
            local value, flags = limit:get("key")
            if value==nil then
                success, err, forcible = limit:add("key",0)
            end
            newval, err = limit:incr("key",1)
            if value > 100 then
                ngx.exit(500)
            else
                --ngx.req.set_header("Content-Type", "text/html")
                ngx.say(value)
            end
        ';
    }
}
